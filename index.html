import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  serverTimestamp,
  setDoc,
  getDocs,
  writeBatch
} from 'firebase/firestore';
import { 
  Utensils, 
  Plus, 
  Trash2, 
  Edit2, 
  Save, 
  Link as LinkIcon, 
  Image as ImageIcon,
  DollarSign,
  Users,
  Calculator,
  ExternalLink,
  X,
  RefreshCw,
  CheckCircle,
  Circle,
  AlertTriangle,
  Upload,
  Clock,
  Info,
  Maximize2,
  MinusCircle
} from 'lucide-react';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Types ---
type Category = 'lunch' | 'drink' | 'tea';

interface OrderItem {
  id: string;
  creatorId: string;
  name: string;
  item: string;
  price: number;
  category: Category;
  timestamp?: any;
}

interface LinkItem {
  label: string;
  url: string;
}

interface AppSettings {
  menuImageUrls: string[]; // æ”¹ç‚ºé™£åˆ—
  menuLinks: LinkItem[];   // æ”¹ç‚ºç‰©ä»¶é™£åˆ—
  shippingCost: number;
  shippingTarget: Category | 'all';
  storeName: string;
  announcement: string;
}

interface PaymentStatus {
  [userName: string]: boolean;
}

// --- Helper: Image Compression ---
const compressImage = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 800;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx?.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.onerror = (error) => reject(error);
    };
    reader.onerror = (error) => reject(error);
  });
};

// --- Main Component ---
export default function OrderSystem() {
  const [user, setUser] = useState<any>(null);
  const [orders, setOrders] = useState<OrderItem[]>([]);
  const [payments, setPayments] = useState<PaymentStatus>({});
  
  // Initial Settings State
  const [settings, setSettings] = useState<AppSettings>({
    menuImageUrls: [],
    menuLinks: [],
    shippingCost: 0,
    shippingTarget: 'lunch',
    storeName: '',
    announcement: ''
  });
  
  // Local state for forms
  const [newName, setNewName] = useState('');
  const [newItem, setNewItem] = useState('');
  const [newPrice, setNewPrice] = useState('');
  const [newCategory, setNewCategory] = useState<Category>('lunch');
  const [editingId, setEditingId] = useState<string | null>(null);
  
  // Editing states
  const [editName, setEditName] = useState('');
  const [editItem, setEditItem] = useState('');
  const [editPrice, setEditPrice] = useState('');
  const [editCategory, setEditCategory] = useState<Category>('lunch');

  // UI States
  const [isEditingSettings, setIsEditingSettings] = useState(false);
  const [isResetModalOpen, setIsResetModalOpen] = useState(false);
  const [tempSettings, setTempSettings] = useState<AppSettings>(settings);
  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  
  // Image Viewer State
  const [viewingImage, setViewingImage] = useState<string | null>(null);
  
  const fileInputRef = useRef<HTMLInputElement>(null);

  // --- Auth & Data Listeners ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;

    // 1. Listen to Orders
    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubscribeOrders = onSnapshot(ordersRef, (snapshot) => {
      const loadedOrders = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as OrderItem[];
      
      // --- ä¿®æ”¹æ’åºé‚è¼¯ (Sorting Logic Update) ---
      loadedOrders.sort((a, b) => {
        // 1. å…ˆä¾ç…§é¡åˆ¥æ’åº (åˆé¤ -> é£²æ–™ -> ä¸‹åˆèŒ¶)
        const catMap: Record<string, number> = { lunch: 1, drink: 2, tea: 3 };
        const cA = catMap[a.category] || 99;
        const cB = catMap[b.category] || 99;
        if (cA !== cB) return cA - cB;

        // 2. å†ä¾ç…§å“é …åç¨±æ’åº (è®“ "ç´…èŒ¶"ã€"ç´…èŒ¶åŠç³–" æ’åœ¨ä¸€èµ·)
        // ä½¿ç”¨ zh-TW æ¯”è¼ƒï¼Œç¢ºä¿ä¸­æ–‡æ’åºæ­£ç¢º
        const itemDiff = a.item.localeCompare(b.item, 'zh-TW');
        if (itemDiff !== 0) return itemDiff;

        // 3. å¦‚æœå“é …å®Œå…¨ä¸€æ¨£ï¼Œä¾ç…§äººåæ’åº
        return a.name.localeCompare(b.name, 'zh-TW');
      });
      
      setOrders(loadedOrders);
    }, (error) => console.error("Error fetching orders:", error));

    // 2. Listen to Settings (With Migration Logic)
    const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
    const unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        
        // Migration: Handle old single image format
        let images: string[] = [];
        if (Array.isArray(data.menuImageUrls)) {
          images = data.menuImageUrls;
        } else if (data.menuImageUrl) {
          images = [data.menuImageUrl];
        }

        // Migration: Handle old single link format
        let links: LinkItem[] = [];
        if (Array.isArray(data.menuLinks)) {
          links = data.menuLinks;
        } else if (data.menuLink) {
          links = [{ label: 'ç›¸é—œé€£çµ', url: data.menuLink }];
        }

        setSettings({
          shippingCost: data.shippingCost || 0,
          shippingTarget: data.shippingTarget || 'lunch',
          storeName: data.storeName || '',
          announcement: data.announcement || '',
          menuImageUrls: images,
          menuLinks: links
        });
      }
    }, (error) => console.error("Error fetching settings:", error));

    // 3. Listen to Payments
    const paymentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'payments');
    const unsubscribePayments = onSnapshot(paymentsRef, (snapshot) => {
      const loadedPayments: PaymentStatus = {};
      snapshot.docs.forEach(doc => {
        loadedPayments[doc.id] = doc.data().paid;
      });
      setPayments(loadedPayments);
    }, (error) => console.error("Error fetching payments:", error));

    return () => {
      unsubscribeOrders();
      unsubscribeSettings();
      unsubscribePayments();
    };
  }, [user]);

  // --- Actions ---

  const handleAddOrder = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) { alert("è«‹ç­‰å¾…é€£ç·š..."); return; }
    if (!newName || !newItem || !newPrice) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        creatorId: user.uid,
        name: newName.trim(),
        item: newItem,
        price: Number(newPrice),
        category: newCategory,
        timestamp: serverTimestamp()
      });
      setNewItem('');
      setNewPrice('');
    } catch (error) {
      console.error("Error adding order:", error);
      alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
    }
  };

  const handleDeleteClick = (id: string) => {
    if (deleteConfirmId === id) {
      handleDeleteConfirm(id);
    } else {
      setDeleteConfirmId(id);
      setTimeout(() => setDeleteConfirmId(null), 3000);
    }
  };

  const handleDeleteConfirm = async (id: string) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
      setDeleteConfirmId(null);
    } catch (error) {
      console.error("Error deleting:", error);
      alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦ã€‚');
    }
  };

  const startEdit = (order: OrderItem) => {
    setEditingId(order.id);
    setEditName(order.name);
    setEditItem(order.item);
    setEditPrice(order.price.toString());
    setEditCategory(order.category);
    setDeleteConfirmId(null);
  };

  const saveEdit = async () => {
    if (!editingId || !user) return;
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingId), {
        name: editName.trim(),
        item: editItem,
        price: Number(editPrice),
        category: editCategory
      });
      setEditingId(null);
    } catch (error) {
      console.error("Error updating:", error);
      alert("æ›´æ–°å¤±æ•—");
    }
  };

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    try {
      const compressedBase64 = await compressImage(file);
      setTempSettings(prev => ({ 
        ...prev, 
        menuImageUrls: [...prev.menuImageUrls, compressedBase64] 
      }));
    } catch (error) {
      console.error("Error processing image:", error);
      alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹è©¦è©¦çœ‹åˆ¥å¼µåœ–ç‰‡");
    } finally {
      setIsUploading(false);
      // Reset input so same file can be selected again if needed
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const handleRemoveImage = (indexToRemove: number) => {
    setTempSettings(prev => ({
      ...prev,
      menuImageUrls: prev.menuImageUrls.filter((_, index) => index !== indexToRemove)
    }));
  };

  const handleAddLink = () => {
    setTempSettings(prev => ({
      ...prev,
      menuLinks: [...prev.menuLinks, { label: '', url: '' }]
    }));
  };

  const handleRemoveLink = (indexToRemove: number) => {
    setTempSettings(prev => ({
      ...prev,
      menuLinks: prev.menuLinks.filter((_, index) => index !== indexToRemove)
    }));
  };

  const handleLinkChange = (index: number, field: keyof LinkItem, value: string) => {
    const newLinks = [...tempSettings.menuLinks];
    newLinks[index] = { ...newLinks[index], [field]: value };
    setTempSettings({ ...tempSettings, menuLinks: newLinks });
  };

  const handleUpdateSettings = async () => {
    if (!user) return;
    try {
      // Clean up empty links
      const cleanLinks = tempSettings.menuLinks.filter(l => l.url.trim() !== '');
      const finalSettings = { ...tempSettings, menuLinks: cleanLinks };

      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), finalSettings);
      setIsEditingSettings(false);
      alert('ç™¼å¸ƒæˆåŠŸï¼');
    } catch (error) {
      console.error("Error saving settings:", error);
      alert('ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–åœ–ç‰‡æ˜¯å¦å¤ªå¤§ã€‚');
    }
  };

  const handleTogglePayment = async (userName: string, currentStatus: boolean) => {
    if (!userName || !user) return;
    try {
      const safeId = userName; 
      const paymentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'payments', safeId);
      
      if (currentStatus) {
        await deleteDoc(paymentDocRef);
      } else {
        await setDoc(paymentDocRef, { paid: true });
      }
    } catch (error) {
      console.error("Error toggling payment:", error);
    }
  };

  const handleResetAll = async () => {
    if (!user) return;
    try {
      const batch = writeBatch(db);
      const ordersSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
      ordersSnapshot.forEach((doc) => batch.delete(doc.ref));
      const paymentsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'payments'));
      paymentsSnapshot.forEach((doc) => batch.delete(doc.ref));
      await batch.commit();
      setIsResetModalOpen(false);
      alert('å·²å…¨éƒ¨é‡ç½®ï¼å¯ä»¥é–‹å§‹æ–°çš„ä¸€åœ˜äº†ã€‚');
    } catch (error) {
      console.error("Error resetting data:", error);
      alert('é‡ç½®å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¨å¾Œå†è©¦ã€‚');
    }
  };

  // --- Calculations ---
  const summaryData = useMemo(() => {
    const summary: Record<string, { 
      lunch: number, drink: number, tea: number, items: string[], totalItemCost: number 
    }> = {};

    const uniqueUsersByCategory: Record<string, Set<string>> = {
      lunch: new Set(), drink: new Set(), tea: new Set(), all: new Set()
    };

    orders.forEach(order => {
      const cleanName = order.name.trim();
      if (!summary[cleanName]) {
        summary[cleanName] = { lunch: 0, drink: 0, tea: 0, items: [], totalItemCost: 0 };
      }
      summary[cleanName][order.category] += order.price;
      summary[cleanName].totalItemCost += order.price;
      summary[cleanName].items.push(`${order.item} ($${order.price})`);

      uniqueUsersByCategory[order.category].add(cleanName);
      uniqueUsersByCategory['all'].add(cleanName);
    });

    let targetUsersCount = 0;
    const currentTarget = settings.shippingTarget || 'lunch';

    if (currentTarget === 'all') {
      targetUsersCount = uniqueUsersByCategory['all'].size;
    } else {
      targetUsersCount = uniqueUsersByCategory[currentTarget].size;
    }

    const shippingPerPerson = targetUsersCount > 0 
      ? Math.ceil(settings.shippingCost / targetUsersCount) 
      : 0;

    const result = Object.entries(summary).map(([name, data]) => {
      let needsToPayShipping = false;
      if (currentTarget === 'all') {
        needsToPayShipping = true;
      } else if (uniqueUsersByCategory[currentTarget].has(name)) {
        needsToPayShipping = true;
      }
      const myShipping = needsToPayShipping ? shippingPerPerson : 0;
      const isPaid = !!payments[name];

      return {
        name, ...data, shipping: myShipping, finalTotal: data.totalItemCost + myShipping, isPaid
      };
    });
    
    result.sort((a, b) => {
      if (a.isPaid === b.isPaid) return a.name.localeCompare(b.name);
      return a.isPaid ? 1 : -1;
    });

    return { result, shippingPerPerson, targetUsersCount };
  }, [orders, settings, payments]);

  const getCategoryLabel = (cat: string) => {
    switch(cat) {
      case 'lunch': return 'åˆé¤';
      case 'drink': return 'é£²æ–™';
      case 'tea': return 'ä¸‹åˆèŒ¶';
      default: return 'å…¨éƒ¨';
    }
  };

  const getCategoryColor = (cat: string) => {
    switch(cat) {
      case 'lunch': return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'drink': return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'tea': return 'bg-pink-100 text-pink-800 border-pink-200';
      default: return 'bg-gray-100';
    }
  };

  return (
    <div className="min-h-screen bg-stone-50 pb-20 font-sans text-stone-800">
      
      {/* Header - No sticky */}
      <div className="bg-white shadow-sm border-b border-stone-200">
        <div className="max-w-4xl mx-auto p-4">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold text-stone-800 flex items-center gap-2">
                <Utensils className="text-orange-500" />
                è¨‚é¤å°å¹«æ‰‹
              </h1>
              <p className="text-sm text-stone-500 mt-1">
                 {settings.storeName || 'å°šæœªè¨­å®šåº—å®¶åç¨±'}
              </p>
            </div>
            
            <div className="flex gap-2 w-full sm:w-auto">
               <button 
                onClick={() => {
                  setTempSettings({
                    ...settings,
                    // If opening settings and links list is empty, add one empty row for convenience
                    menuLinks: settings.menuLinks.length === 0 ? [{label: '', url: ''}, {label: '', url: ''}] : settings.menuLinks
                  });
                  setIsEditingSettings(true);
                }}
                className="flex-1 sm:flex-none px-3 py-2 text-sm bg-stone-100 hover:bg-stone-200 rounded-lg flex items-center justify-center gap-1 transition-colors text-stone-700"
              >
                <Edit2 size={16} /> ç™¼å¸ƒ/è¨­å®š
              </button>
              <button 
                onClick={() => setIsResetModalOpen(true)}
                className="flex-1 sm:flex-none px-3 py-2 text-sm bg-red-50 hover:bg-red-100 text-red-600 border border-red-100 rounded-lg flex items-center justify-center gap-1 transition-colors"
              >
                <RefreshCw size={16} /> é–‹å§‹æ–°ä¸€åœ˜
              </button>
            </div>
          </div>
          
          {/* Announcement */}
          {settings.announcement && (
            <div className="mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg flex gap-3 items-start">
              <Info className="text-blue-500 flex-shrink-0 mt-0.5" size={18} />
              <div className="text-sm text-blue-900 whitespace-pre-wrap flex-1 leading-relaxed">
                {settings.announcement}
              </div>
            </div>
          )}

          {/* Menu & Links Display Area */}
          {(settings.menuImageUrls.length > 0 || settings.menuLinks.length > 0) && (
            <div className="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100">
               <div className="flex flex-col gap-4">
                  
                  {/* Images Gallery */}
                  {settings.menuImageUrls.length > 0 && (
                    <div className="flex gap-4 overflow-x-auto pb-2 scrollbar-hide">
                      {settings.menuImageUrls.map((url, idx) => (
                        <div 
                          key={idx}
                          className="flex-shrink-0 w-48 h-32 bg-white rounded-lg border border-stone-200 flex items-center justify-center overflow-hidden cursor-zoom-in group relative shadow-sm" 
                          onClick={() => setViewingImage(url)}
                        >
                          <img src={url} alt={`Menu ${idx + 1}`} className="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                             <Maximize2 className="text-white opacity-0 group-hover:opacity-100 drop-shadow-md" size={24} />
                          </div>
                          {settings.menuImageUrls.length > 1 && (
                            <span className="absolute bottom-1 right-1 bg-black/50 text-white text-xs px-1.5 py-0.5 rounded">
                              {idx + 1}/{settings.menuImageUrls.length}
                            </span>
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Links & Details */}
                  <div className="flex-1">
                    <h3 className="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                      æœ¬æ¬¡åœ˜è³¼è³‡è¨Š
                      {settings.menuLinks.length > 0 && <span className="text-xs font-normal text-yellow-600 bg-yellow-100 px-2 rounded-full">é€£çµ</span>}
                    </h3>
                    
                    {settings.storeName && <p className="text-stone-700 font-medium mb-2">{settings.storeName}</p>}
                    
                    {/* Dynamic Links List */}
                    <div className="flex flex-wrap gap-2 mb-3">
                      {settings.menuLinks.map((link, idx) => link.url && (
                        <a 
                          key={idx} 
                          href={link.url} 
                          target="_blank" 
                          rel="noreferrer" 
                          className="inline-flex items-center text-blue-600 hover:text-blue-700 hover:bg-blue-50 gap-1 text-sm bg-white px-3 py-1.5 rounded-lg border border-blue-100 shadow-sm transition-colors"
                        >
                          <ExternalLink size={14} /> 
                          {link.label || 'ç›¸é—œé€£çµ'}
                        </a>
                      ))}
                    </div>

                    <div className="mt-2 text-sm text-stone-600 flex flex-wrap gap-2 pt-2 border-t border-yellow-200/50">
                      <span className="bg-white px-2 py-1 rounded border border-stone-200">
                        é‹è²»ç¸½é¡: ${settings.shippingCost}
                      </span>
                      <span className="bg-white px-2 py-1 rounded border border-stone-200">
                        åˆ†æ”¤å°è±¡: <span className="font-medium text-indigo-600">{getCategoryLabel(settings.shippingTarget)}</span>
                      </span>
                      {summaryData.shippingPerPerson > 0 && (
                        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 font-medium">
                          æ¯äººåˆ†æ”¤: ${summaryData.shippingPerPerson} ({summaryData.targetUsersCount}äºº)
                        </span>
                      )}
                    </div>
                  </div>
               </div>
            </div>
          )}
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-4xl mx-auto p-4 space-y-8">
        {/* Input Section */}
        <section className="bg-white p-4 rounded-xl shadow-sm border border-stone-200">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <Plus size={20} className="text-green-500" />
            æˆ‘è¦é»é¤
          </h2>
          <form onSubmit={handleAddOrder} className="flex flex-wrap gap-3 items-end">
            <div className="w-full sm:w-auto flex-1 min-w-[120px]">
              <label className="block text-xs font-medium text-stone-500 mb-1">åå­—</label>
              <input 
                type="text" 
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                placeholder="Ex: å°æ˜"
                className="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none transition-all"
                required
              />
            </div>
            
            <div className="w-1/3 sm:w-auto min-w-[100px]">
               <label className="block text-xs font-medium text-stone-500 mb-1">ç¨®é¡</label>
               <select 
                value={newCategory} 
                onChange={(e) => setNewCategory(e.target.value as Category)}
                className="w-full px-3 py-2 border border-stone-300 rounded-lg bg-white focus:ring-2 focus:ring-orange-200 outline-none"
               >
                 <option value="lunch">ğŸ± åˆé¤</option>
                 <option value="drink">ğŸ¥¤ é£²æ–™</option>
                 <option value="tea">ğŸ° ä¸‹åˆèŒ¶</option>
               </select>
            </div>

            <div className="w-full sm:w-auto flex-[2] min-w-[160px]">
              <label className="block text-xs font-medium text-stone-500 mb-1">å“é …</label>
              <input 
                type="text" 
                value={newItem}
                onChange={(e) => setNewItem(e.target.value)}
                placeholder="Ex: é›è…¿ä¾¿ç•¶ / åŠç³–å°‘å†°"
                className="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none transition-all"
                required
              />
            </div>

            <div className="w-1/3 sm:w-24">
              <label className="block text-xs font-medium text-stone-500 mb-1">é‡‘é¡</label>
              <input 
                type="number" 
                value={newPrice}
                onChange={(e) => setNewPrice(e.target.value)}
                placeholder="100"
                className="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none transition-all"
                required
              />
            </div>

            <button 
              type="submit" 
              className="w-full sm:w-auto px-6 py-2 bg-stone-800 hover:bg-stone-700 text-white rounded-lg font-medium shadow-sm transition-colors flex items-center justify-center gap-2"
            >
              <Plus size={18} /> æ–°å¢
            </button>
          </form>
        </section>

        {/* Order List */}
        <section>
          <div className="flex items-center justify-between mb-3 px-1">
             <h2 className="text-lg font-semibold text-stone-700 flex items-center gap-2">
               <Users size={20} className="text-blue-500" />
               é»é¤æ˜ç´°
               <span className="text-sm font-normal text-stone-400 bg-stone-100 px-2 py-0.5 rounded-full">{orders.length} é …</span>
             </h2>
          </div>
          
          <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-left text-sm">
                <thead className="bg-stone-50 text-stone-500 border-b border-stone-200">
                  <tr>
                    <th className="px-4 py-3 font-medium whitespace-nowrap w-24">é¡åˆ¥</th>
                    <th className="px-4 py-3 font-medium whitespace-nowrap w-32">å§“å</th>
                    <th className="px-4 py-3 font-medium">å“é …</th>
                    <th className="px-4 py-3 font-medium text-right w-24">é‡‘é¡</th>
                    <th className="px-4 py-3 font-medium text-right w-24">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-stone-100">
                  {orders.length === 0 ? (
                    <tr>
                      <td colSpan={5} className="px-4 py-8 text-center text-stone-400">
                        ç›®å‰é‚„æ²’æœ‰äººé»é¤ï¼Œå¿«ç•¶ç¬¬ä¸€å€‹å§ï¼
                      </td>
                    </tr>
                  ) : orders.map((order) => (
                    <tr key={order.id} className="hover:bg-stone-50 transition-colors group">
                      {editingId === order.id ? (
                        <>
                          <td className="px-4 py-2">
                            <select 
                              value={editCategory}
                              onChange={(e) => setEditCategory(e.target.value as Category)}
                              className="w-full p-1 border rounded"
                            >
                               <option value="lunch">åˆé¤</option>
                               <option value="drink">é£²æ–™</option>
                               <option value="tea">ä¸‹åˆèŒ¶</option>
                            </select>
                          </td>
                          <td className="px-4 py-2">
                            <input 
                              value={editName}
                              onChange={(e) => setEditName(e.target.value)}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="px-4 py-2">
                             <input 
                              value={editItem}
                              onChange={(e) => setEditItem(e.target.value)}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="px-4 py-2 text-right">
                             <input 
                              type="number"
                              value={editPrice}
                              onChange={(e) => setEditPrice(e.target.value)}
                              className="w-full p-1 border rounded text-right"
                            />
                          </td>
                          <td className="px-4 py-2 text-right">
                            <div className="flex justify-end gap-1">
                              <button onClick={saveEdit} className="p-1 text-green-600 hover:bg-green-50 rounded"><Save size={16} /></button>
                              <button onClick={() => setEditingId(null)} className="p-1 text-stone-400 hover:bg-stone-100 rounded"><X size={16} /></button>
                            </div>
                          </td>
                        </>
                      ) : (
                        <>
                          <td className="px-4 py-3">
                            <span className={`inline-block px-2 py-0.5 rounded text-xs font-medium border ${getCategoryColor(order.category)}`}>
                              {getCategoryLabel(order.category)}
                            </span>
                          </td>
                          <td className="px-4 py-3 font-medium text-stone-700">{order.name}</td>
                          <td className="px-4 py-3 text-stone-600">{order.item}</td>
                          <td className="px-4 py-3 text-right font-medium text-stone-800">${order.price}</td>
                          <td className="px-4 py-3 text-right">
                             <div className="flex justify-end gap-2 items-center">
                                <button 
                                  onClick={() => startEdit(order)}
                                  className="text-stone-300 hover:text-blue-500 transition-colors"
                                  title="ç·¨è¼¯"
                                >
                                  <Edit2 size={16} />
                                </button>
                                <button 
                                  onClick={() => handleDeleteClick(order.id)}
                                  className={`transition-all duration-200 ${
                                    deleteConfirmId === order.id 
                                      ? 'bg-red-500 text-white p-1 rounded hover:bg-red-600 shadow-sm' 
                                      : 'text-stone-300 hover:text-red-500'
                                  }`}
                                  title={deleteConfirmId === order.id ? "ç¢ºèªåˆªé™¤?" : "åˆªé™¤"}
                                >
                                  {deleteConfirmId === order.id ? <Trash2 size={14} /> : <Trash2 size={16} />}
                                </button>
                             </div>
                          </td>
                        </>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        {/* Summary Table */}
        <section>
          <div className="flex items-center justify-between mb-3 px-1">
             <h2 className="text-lg font-semibold text-stone-700 flex items-center gap-2">
               <Calculator size={20} className="text-purple-500" />
               çµå¸³ç¸½è¡¨
             </h2>
             <div className="text-sm text-stone-500">
               é‹è²»è¨­å®š: <span className="font-medium text-stone-800">${settings.shippingCost}</span> Ã· <span className="font-medium text-stone-800">{getCategoryLabel(settings.shippingTarget)}</span>
             </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
             <div className="overflow-x-auto">
                <table className="w-full text-left text-sm">
                  <thead className="bg-purple-50 text-purple-900 border-b border-purple-100">
                    <tr>
                      <th className="px-4 py-3 w-32">å§“å</th>
                      <th className="px-4 py-3 text-right w-24">åˆé¤</th>
                      <th className="px-4 py-3 text-right w-24">é£²æ–™</th>
                      <th className="px-4 py-3 text-right w-24">ä¸‹åˆèŒ¶</th>
                      <th className="px-4 py-3 text-right w-24 text-stone-500">åˆ†æ”¤é‹è²»</th>
                      <th className="px-4 py-3 text-right font-bold w-32">æ‡‰ä»˜ç¸½é¡</th>
                      <th className="px-4 py-3 text-center w-24">å·²ä»˜æ¬¾?</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-stone-100">
                    {summaryData.result.length === 0 ? (
                       <tr><td colSpan={7} className="px-4 py-8 text-center text-stone-400">å°šç„¡è³‡æ–™</td></tr>
                    ) : summaryData.result.map((row) => (
                      <tr key={row.name} className={`hover:bg-stone-50 transition-colors ${row.isPaid ? 'bg-green-50/50' : ''}`}>
                        <td className="px-4 py-3 font-medium text-stone-800 flex items-center gap-2">
                          {row.name}
                          {row.isPaid && <CheckCircle size={14} className="text-green-500" />}
                        </td>
                        <td className="px-4 py-3 text-right text-stone-600">{row.lunch > 0 ? `$${row.lunch}` : '-'}</td>
                        <td className="px-4 py-3 text-right text-stone-600">{row.drink > 0 ? `$${row.drink}` : '-'}</td>
                        <td className="px-4 py-3 text-right text-stone-600">{row.tea > 0 ? `$${row.tea}` : '-'}</td>
                        <td className="px-4 py-3 text-right text-stone-500 text-xs">
                          {row.shipping > 0 ? `+$${row.shipping}` : '-'}
                        </td>
                        <td className={`px-4 py-3 text-right font-bold text-lg ${row.isPaid ? 'text-green-600 decoration-stone-400' : 'text-purple-700'}`}>
                          ${row.finalTotal}
                        </td>
                        <td className="px-4 py-3 text-center">
                           <input 
                             type="checkbox"
                             checked={row.isPaid}
                             onChange={() => handleTogglePayment(row.name, row.isPaid)}
                             className="w-5 h-5 text-green-600 rounded border-stone-300 focus:ring-green-500 cursor-pointer"
                           />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot className="bg-stone-50 border-t border-stone-200 font-bold text-stone-800">
                    <tr>
                      <td className="px-4 py-3">åˆè¨ˆ</td>
                      <td className="px-4 py-3 text-right">${summaryData.result.reduce((a, b) => a + b.lunch, 0)}</td>
                      <td className="px-4 py-3 text-right">${summaryData.result.reduce((a, b) => a + b.drink, 0)}</td>
                      <td className="px-4 py-3 text-right">${summaryData.result.reduce((a, b) => a + b.tea, 0)}</td>
                      <td className="px-4 py-3 text-right text-stone-500">${summaryData.result.reduce((a, b) => a + b.shipping, 0)}</td>
                      <td className="px-4 py-3 text-right text-purple-700 text-lg">
                        ${summaryData.result.reduce((a, b) => a + b.finalTotal, 0)}
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
             </div>
          </div>
        </section>
      </div>

      {/* Settings Modal */}
      {isEditingSettings && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in max-h-[90vh] overflow-y-auto">
            <div className="px-6 py-4 border-b border-stone-100 flex justify-between items-center sticky top-0 bg-white z-10">
              <h3 className="font-bold text-lg">ç™¼å¸ƒè³‡è¨Š & é‹è²»è¨­å®š</h3>
              <button onClick={() => setIsEditingSettings(false)} className="text-stone-400 hover:text-stone-600">
                <X size={20} />
              </button>
            </div>
            
            <div className="p-6 space-y-5">
              
              <div>
                <label className="block text-sm font-medium text-stone-700 mb-1">åº—å®¶åç¨±</label>
                <input 
                  type="text"
                  value={tempSettings.storeName}
                  onChange={(e) => setTempSettings({...tempSettings, storeName: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-100 outline-none"
                  placeholder="ä¾‹å¦‚: 50åµ"
                />
              </div>

              {/* Announcement Input */}
              <div>
                <label className="block text-sm font-medium text-stone-700 mb-1 flex items-center gap-1">
                  <Clock size={16} /> å…¬å‘Š / æˆªæ­¢æ™‚é–“
                </label>
                <textarea
                  value={tempSettings.announcement}
                  onChange={(e) => setTempSettings({...tempSettings, announcement: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-100 outline-none text-sm h-20 resize-none"
                  placeholder="ä¾‹å¦‚ï¼šä¸‹åˆ3é»çµå–®ï¼Œè«‹å¤§å®¶æº–æ™‚å¡«å¯«ï¼"
                />
              </div>

              {/* Image Input (Multiple) */}
              <div>
                <label className="block text-sm font-medium text-stone-700 mb-2">èœå–®åœ–ç‰‡ (å¯å¤šå¼µ)</label>
                
                {/* Image List */}
                {tempSettings.menuImageUrls.length > 0 && (
                  <div className="flex gap-2 mb-3 overflow-x-auto pb-2">
                    {tempSettings.menuImageUrls.map((url, idx) => (
                       <div key={idx} className="relative flex-shrink-0 w-24 h-24 border rounded-lg overflow-hidden group">
                         <img src={url} alt="Menu" className="w-full h-full object-cover" />
                         <button 
                           onClick={() => handleRemoveImage(idx)}
                           className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                         >
                           <X size={12} />
                         </button>
                       </div>
                    ))}
                  </div>
                )}

                {/* Upload Button */}
                <button 
                  onClick={() => fileInputRef.current?.click()}
                  className={`w-full py-2 border-2 border-dashed border-stone-300 rounded-lg flex items-center justify-center gap-2 text-stone-500 hover:border-blue-400 hover:text-blue-500 transition-colors ${isUploading ? 'bg-stone-50 cursor-wait' : ''}`}
                  disabled={isUploading}
                >
                  {isUploading ? (
                    <span>è™•ç†ä¸­...</span>
                  ) : (
                    <>
                      <Upload size={18} />
                      <span>ä¸Šå‚³åœ–ç‰‡ (æ‰‹æ©Ÿ/é›»è…¦)</span>
                    </>
                  )}
                </button>
                <input 
                  type="file" 
                  ref={fileInputRef}
                  onChange={handleImageUpload}
                  accept="image/*"
                  className="hidden"
                />
              </div>

              {/* Multiple Links Input */}
              <div>
                <div className="flex justify-between items-center mb-2">
                   <label className="block text-sm font-medium text-stone-700">åº—å®¶ç¶²å€ / ç›¸é—œé€£çµ</label>
                   <button 
                     onClick={handleAddLink}
                     className="text-xs flex items-center gap-1 text-blue-600 hover:bg-blue-50 px-2 py-1 rounded"
                   >
                     <Plus size={12} /> æ–°å¢æ¬„ä½
                   </button>
                </div>
                
                <div className="space-y-2">
                  {tempSettings.menuLinks.map((link, idx) => (
                    <div key={idx} className="flex gap-2">
                      <input 
                        type="text"
                        value={link.label}
                        onChange={(e) => handleLinkChange(idx, 'label', e.target.value)}
                        className="w-24 px-2 py-2 border rounded-lg text-sm bg-stone-50"
                        placeholder="åç¨±(å¦‚:é£²æ–™)"
                      />
                      <div className="flex-1 relative">
                        <LinkIcon size={14} className="absolute left-3 top-3 text-stone-400" />
                        <input 
                          type="text"
                          value={link.url}
                          onChange={(e) => handleLinkChange(idx, 'url', e.target.value)}
                          className="w-full pl-8 pr-2 py-2 border rounded-lg text-sm"
                          placeholder="https://..."
                        />
                      </div>
                      <button 
                        onClick={() => handleRemoveLink(idx)}
                        className="p-2 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded"
                      >
                         <MinusCircle size={18} />
                      </button>
                    </div>
                  ))}
                  {tempSettings.menuLinks.length === 0 && (
                    <p className="text-xs text-stone-400 text-center py-2">ç›®å‰æ²’æœ‰é€£çµï¼ŒæŒ‰å³ä¸Šè§’æ–°å¢ã€‚</p>
                  )}
                </div>
              </div>

              <div className="border-t border-stone-100 my-4 pt-4">
                <h4 className="font-medium text-stone-800 mb-3 flex items-center gap-2">
                   <DollarSign size={16} /> é‹è²»è¨ˆç®—
                </h4>
                
                <div className="flex gap-4 mb-3">
                   <div className="flex-1">
                      <label className="block text-xs font-medium text-stone-500 mb-1">ç¸½é‹è²» ($)</label>
                      <input 
                        type="number"
                        value={tempSettings.shippingCost}
                        onChange={(e) => setTempSettings({...tempSettings, shippingCost: Number(e.target.value)})}
                        className="w-full px-3 py-2 border rounded-lg"
                      />
                   </div>
                   <div className="flex-1">
                      <label className="block text-xs font-medium text-stone-500 mb-1">åˆ†æ”¤å°è±¡</label>
                      <select 
                        value={tempSettings.shippingTarget}
                        onChange={(e) => setTempSettings({...tempSettings, shippingTarget: e.target.value as any})}
                        className="w-full px-3 py-2 border rounded-lg bg-white"
                      >
                        <option value="lunch">åƒ…è¨‚åˆé¤è€…</option>
                        <option value="drink">åƒ…è¨‚é£²æ–™è€…</option>
                        <option value="tea">åƒ…è¨‚ä¸‹åˆèŒ¶è€…</option>
                        <option value="all">æ‰€æœ‰äººå¹³å‡</option>
                      </select>
                   </div>
                </div>
              </div>

            </div>
            
            <div className="px-6 py-4 bg-stone-50 border-t border-stone-100 flex justify-end gap-2 sticky bottom-0">
              <button 
                onClick={() => setIsEditingSettings(false)}
                className="px-4 py-2 text-stone-600 hover:bg-stone-200 rounded-lg transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleUpdateSettings}
                className="px-4 py-2 bg-stone-800 text-white hover:bg-stone-700 rounded-lg transition-colors font-medium"
              >
                å„²å­˜ç™¼å¸ƒ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Reset Confirmation Modal */}
      {isResetModalOpen && (
        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4">
           <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in">
              <div className="p-6 text-center">
                 <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                   <AlertTriangle size={32} />
                 </div>
                 <h3 className="text-xl font-bold text-stone-800 mb-2">ç¢ºå®šè¦é–‹å§‹æ–°ä¸€åœ˜å—ï¼Ÿ</h3>
                 <p className="text-stone-500 text-sm mb-6">
                   é€™å°‡æœƒ<span className="text-red-600 font-bold">æ°¸ä¹…åˆªé™¤</span>ç›®å‰åˆ—è¡¨ä¸Šçš„ã€Œæ‰€æœ‰è¨‚å–®ã€å’Œã€Œå·²ä»˜æ¬¾ç´€éŒ„ã€ï¼Œè®“å¤§å®¶é‡æ–°é»é¤ã€‚
                   <br/>(åº—å®¶è¨­å®šæœƒä¿ç•™)
                 </p>
                 
                 <div className="flex gap-3">
                   <button 
                     onClick={() => setIsResetModalOpen(false)}
                     className="flex-1 py-3 bg-stone-100 text-stone-700 font-medium rounded-lg hover:bg-stone-200 transition-colors"
                   >
                     å–æ¶ˆ
                   </button>
                   <button 
                     onClick={handleResetAll}
                     className="flex-1 py-3 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 shadow-lg shadow-red-200 transition-colors"
                   >
                     ç¢ºèªæ¸…ç©º
                   </button>
                 </div>
              </div>
           </div>
        </div>
      )}

      {/* Image Viewer Lightbox */}
      {viewingImage && (
        <div 
          className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 cursor-zoom-out animate-fade-in"
          onClick={() => setViewingImage(null)}
        >
          <img 
            src={viewingImage} 
            alt="Menu Full Screen" 
            className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
          />
          <button 
            onClick={(e) => { e.stopPropagation(); setViewingImage(null); }}
            className="absolute top-4 right-4 text-white/70 hover:text-white p-2 transition-colors bg-black/20 rounded-full"
          >
            <X size={32} />
          </button>
        </div>
      )}

    </div>
  );
}